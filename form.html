<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FESH Multi-Step Form with LocalStorage Save</title>
  <style>
    .step {
      display: none;
      border: 1px solid #ccc;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 10px;
      background-color: #f9f9f9;
    }
    .step.active {
      display: block;
    }
    button {
      padding: 8px 16px;
      margin-top: 10px;
      border-radius: 6px;
      cursor: pointer;
    }
    .mic-button {
      margin-right: 10px;
    }
    .hidden {
      display: none;
    }
    .step-header {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    .step-box {
      display: inline-block;
      padding: 10px 15px;
      margin: 0 10px;
      background-color: #e0e0e0;
      border-radius: 10px;
      font-weight: bold;
      transition: background-color 0.3s ease;
      user-select: none;
    }
    .step-box.active {
      background-color: #4caf50;
      color: white;
    }
    .step-arrow {
      font-size: 20px;
      color: #333;
      user-select: none;
    }
  </style>
</head>
<body>
  <h2>FESH Soil Health Assessment Form (Voice Enabled)</h2>

  <div class="step-header">
    <div class="step-box active" id="header-step1">Step 1: General Info</div>
    <div class="step-arrow">‚Üí</div>
    <div class="step-box" id="header-step2">Step 2: Crop Info</div>
    <div class="step-arrow">‚Üí</div>
    <div class="step-box" id="header-step3">Step 3: Topography</div>
    <div class="step-arrow">‚Üí</div>
    <div class="step-box" id="header-step4">Step 4: Physical Soil</div>
    <div class="step-arrow">‚Üí</div>
    <div class="step-box" id="header-step5">Step 5: Chemical Soil</div>
  </div>

  <form id="feshForm" onsubmit="return false;">
    <!-- Step 1 -->
    <div class="step active" id="step1">
      <h3>Step 1: General Information</h3>
      <label for="farmId">Farm ID:</label>
      <input type="text" id="farmId" name="farmId" readonly /><br /><br />

      <label>Farmer Name:</label>
      <button type="button" class="mic-button" onclick="startDictation('farmerName')">üé§</button>
      <input type="text" id="farmerName" name="farmerName" required /><br /><br />

      <label>Date:</label>
      <input type="date" id="date" name="date" required /><br /><br />

      <label>Phone Number:</label>
      <button type="button" class="mic-button" onclick="startDictation('contact')">üé§</button>
      <input type="tel" id="contact" name="contact" required /><br /><br />

      <h4>Farm Location (GPS):</h4>
      <button type="button" onclick="getLocation()">üìç Get Current Location</button><br /><br />

      <label>Latitude:</label>
      <input type="text" id="latitude" name="latitude" readonly required /><br /><br />

      <label>Longitude:</label>
      <input type="text" id="longitude" name="longitude" readonly required /><br /><br />

      <label>Elevation (m):</label>
      <input type="text" id="elevation" name="elevation" readonly /><br /><br />

      <button type="button" onclick="validateStep1()">‚úî Confirm and Continue</button>
    </div>

    <!-- Step 2 -->
    <div class="step" id="step2">
      <h3>Step 2: Crop Information</h3>
      <label for="crop">Crop Type:</label>
      <select id="crop" name="crop" required onchange="toggleOtherCrop()">
        <option value="">-- Select Crop --</option>
        <option value="Wheat">Wheat</option>
        <option value="Barley">Barley</option>
        <option value="Corn">Corn</option>
        <option value="Soybeans">Soybeans</option>
        <option value="Oats">Oats</option>
        <option value="Canola">Canola</option>
        <option value="Potatoes">Potatoes</option>
        <option value="Blueberries">Blueberries</option>
        <option value="Carrots">Carrots</option>
        <option value="Cabbage">Cabbage</option>
        <option value="Strawberries">Strawberries</option>
        <option value="Turnip">Turnip</option>
        <option value="Apples">Apples</option>
        <option value="Raspberries">Raspberries</option>
        <option value="Pumpkins">Pumpkins</option>
        <option value="Maple (syrup trees)">Maple (syrup trees)</option>
        <option value="Green Beans">Green Beans</option>
        <option value="Peas">Peas</option>
        <option value="Beets">Beets</option>
        <option value="Other">Other</option>
      </select><br /><br />

      <div id="otherCropContainer" class="hidden">
        <label>Specify Other Crop:</label>
        <button type="button" class="mic-button" onclick="startDictation('otherCrop')">üé§</button>
        <input type="text" id="otherCrop" name="otherCrop" /><br /><br />
      </div>

      <label>Land Area (hectares):</label>
      <button type="button" class="mic-button" onclick="startDictation('area')">üé§</button>
      <input type="number" id="area" name="area" required /><br /><br />

      <button type="button" onclick="validateStep2()">‚úî Confirm and Continue</button>
    </div>

    <!-- Step 3 -->
    <div class="step" id="step3">
      <h3>Step 3: Topography Information</h3>
      <label for="slopeValue">Slope:</label>
      <button type="button" class="mic-button" onclick="startDictation('slopeValue')">üé§</button>
      <input type="number" id="slopeValue" name="slopeValue" required />
      <select id="slopeUnit">
        <option value="deg">Degrees (¬∞)</option>
        <option value="percent">Percent (%)</option>
      </select><br /><br />

      <label>Converted:</label>
      <input type="text" id="slopeConverted" readonly /><br /><br />

      <label for="slopeDirection">Slope Direction:</label>
      <select id="slopeDirection" required>
        <option value="">-- Select --</option>
        <option value="North">North</option>
        <option value="South">South</option>
        <option value="East">East</option>
        <option value="West">West</option>
        <option value="Flat">Flat</option>
      </select><br /><br />

      <label for="landscapePosition">Landscape Position:</label>
      <select id="landscapePosition" required>
        <option value="">-- Select --</option>
        <option value="Hilltop">Hilltop</option>
        <option value="Valley">Valley</option>
        <option value="Flatland">Flatland</option>
      </select><br /><br />

      <label for="surfaceForm">Surface Form:</label>
      <select id="surfaceForm" required>
        <option value="">-- Select --</option>
        <option value="Flat">Flat</option>
        <option value="Concave">Concave</option>
        <option value="Convex">Convex</option>
      </select><br /><br />

      <button type="button" onclick="validateStep3()">‚úî Confirm and Continue</button>
    </div>

    <!-- Step 4 -->
    <div class="step" id="step4">
      <h3>Step 4: Physical Soil Properties</h3>

      <label for="tillageDepth">Tillage Layer Depth (cm):</label>
      <button type="button" class="mic-button" onclick="startDictation('tillageDepth')">üé§</button>
      <input type="number" id="tillageDepth" name="tillageDepth" required /><br /><br />

      <label for="strength">Soil Strength:</label>
      <button type="button" class="mic-button" onclick="startDictation('strength')">üé§</button>
      <input type="number" id="strength" required />
      <select id="strengthUnit">
        <option value="kg/cm¬≤">kg/cm¬≤</option>
        <option value="psi">psi</option>
      </select><br /><br />

      <label for="vess">VESS Score:</label>
      <select id="vess" required>
        <option value="">-- Select --</option>
        <option value="Sq1">Sq1 ‚Äì Excellent</option>
        <option value="Sq2">Sq2 ‚Äì Good</option>
        <option value="Sq3">Sq3 ‚Äì Moderate</option>
        <option value="Sq4">Sq4 ‚Äì Poor</option>
        <option value="Sq5">Sq5 ‚Äì Very Poor</option>
      </select>
      <button type="button" onclick="showVessModal()">‚ùì</button><br /><br />

      <label for="infiltration">Water Infiltration Time (min:sec):</label>
      <button type="button" class="mic-button" onclick="startDictation('infiltration')">üé§</button>
      <input type="text" id="infiltration" placeholder="e.g., 2:30" required /><br /><br />

      <button type="button" onclick="validateStep4()">‚úî Confirm and Continue</button>
    </div>

    <!-- Step 5 -->
    <div class="step" id="step5">
      <h3>Step 5: Chemical Soil Properties</h3>

      <label for="ph">Soil pH:</label>
      <button type="button" class="mic-button" onclick="startDictation('ph')">üé§</button>
      <input type="number" id="ph" name="ph" min="3.5" max="9.5" step="0.1" required /><br /><br />

      <label for="soilColor">Soil Color:</label>
      <button type="button" class="mic-button" onclick="startDictation('soilColor')">üé§</button>
      <select id="soilColor" name="soilColor" required>
        <option value="">-- Select Color --</option>
        <option>Very Dark Gray</option>
        <option>Dark Gray</option>
        <option>Gray</option>
        <option>Light Gray</option>
        <option>Very Pale Brown</option>
        <option>Pale Brown</option>
        <option>Brown</option>
        <option>Dark Brown</option>
        <option>Yellowish Brown</option>
        <option>Strong Brown</option>
        <option>Reddish Brown</option>
        <option>Dark Reddish Brown</option>
        <option>Light Yellowish Brown</option>
        <option>Dark Yellowish Brown</option>
        <option>Yellow</option>
        <option>Strong Yellow</option>
        <option>Grayish Yellow</option>
        <option>Light Olive</option>
        <option>Olive</option>
        <option>Dark Olive</option>
        <option>Greenish Brown</option>
        <option>Light Reddish Brown</option>
        <option>Orange Brown</option>
        <option>Dark Grayish Brown</option>
      </select>
      <br /><br />

      <img src="images/color-soil.jpg" alt="Soil Color Guide" style="max-width: 100%; height: auto;" /><br /><br />

      <button type="button" id="finalSubmitButton">üöÄ Submit and Save</button>
    </div>
  </form>

  <script>
    // Step navigation helpers
    function setActiveStep(stepNum) {
      for (let i = 1; i <= 5; i++) {
        document.getElementById('header-step' + i).classList.remove('active');
        document.getElementById('step' + i).classList.remove('active');
      }
      document.getElementById('header-step' + stepNum).classList.add('active');
      document.getElementById('step' + stepNum).classList.add('active');
    }

    // Step 1 validation and next
    function validateStep1() {
      const requiredIds = ['farmerName', 'date', 'contact', 'latitude', 'longitude'];
      if (!validateRequiredFields(requiredIds)) return;
      setActiveStep(2);
    }

    // Step 2 validation and next
    function validateStep2() {
      const crop = document.getElementById('crop').value;
      const otherCrop = document.getElementById('otherCrop').value;
      const area = document.getElementById('area').value;
      if (!crop) {
        alert('Please select crop type.');
        return;
      }
      if (crop === 'Other' && !otherCrop.trim()) {
        alert('Please specify the other crop.');
        return;
      }
      if (!area) {
        alert('Please enter land area.');
        return;
      }
      setActiveStep(3);
    }

    // Step 3 validation and next
    function validateStep3() {
      const requiredIds = ['slopeValue', 'slopeDirection', 'landscapePosition', 'surfaceForm'];
      if (!validateRequiredFields(requiredIds)) return;
      setActiveStep(4);
    }

    // Step 4 validation and next
    function validateStep4() {
      const requiredIds = ['tillageDepth', 'strength', 'vess', 'infiltration'];
      if (!validateRequiredFields(requiredIds)) return;
      setActiveStep(5);
    }

    // Validate required fields helper
    function validateRequiredFields(ids) {
      for (const id of ids) {
        const el = document.getElementById(id);
        if (!el.value || !el.value.trim()) {
          alert('Please fill all required fields.');
          el.focus();
          return false;
        }
      }
      return true;
    }

    // Voice input function
    function startDictation(fieldId) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        alert('Your browser does not support voice input.');
        return;
      }
      const recognition = new SpeechRecognition();
      recognition.lang = 'en-US';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      recognition.start();
      recognition.onresult = function(event) {
        const result = event.results[0][0].transcript;
        document.getElementById(fieldId).value = result;
      };
      recognition.onerror = function(event) {
        alert('Voice input error: ' + event.error);
      };
    }

    // Geolocation
    function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(successCallback, errorCallback, {
          enableHighAccuracy: true
        });
      } else {
        alert('Your browser does not support geolocation.');
      }
    }
    function successCallback(position) {
      document.getElementById('latitude').value = position.coords.latitude.toFixed(6);
      document.getElementById('longitude').value = position.coords.longitude.toFixed(6);
      if (position.coords.altitude !== null) {
        document.getElementById('elevation').value = position.coords.altitude.toFixed(2);
      } else {
        document.getElementById('elevation').value = '‚Äî';
      }
    }
    function errorCallback(error) {
      alert('Location error: ' + error.message);
    }

    // Toggle Other Crop field
    function toggleOtherCrop() {
      const cropSelect = document.getElementById('crop');
      const otherContainer = document.getElementById('otherCropContainer');
      if (cropSelect.value === 'Other') {
        otherContainer.classList.remove('hidden');
      } else {
        otherContainer.classList.add('hidden');
        document.getElementById('otherCrop').value = '';
      }
    }

    // Slope conversion
    function convertSlope() {
      const value = parseFloat(document.getElementById('slopeValue').value);
      const unit = document.getElementById('slopeUnit').value;
      const output = document.getElementById('slopeConverted');

      if (!isNaN(value)) {
        if (unit === 'deg') {
          const percent = Math.tan(value * Math.PI / 180) * 100;
          output.value = percent.toFixed(1) + ' %';
        } else {
          const degrees = Math.atan(value / 100) * (180 / Math.PI);
          output.value = degrees.toFixed(1) + ' ¬∞';
        }
      } else {
        output.value = '';
      }
    }
    document.getElementById('slopeValue').addEventListener('input', convertSlope);
    document.getElementById('slopeUnit').addEventListener('change', convertSlope);

    // Save form data to localStorage and redirect
    function saveFormDataToLocalStorage() {
      const formData = {
        farmId: document.getElementById('farmId').value,
        farmerName: document.getElementById('farmerName').value,
        date: document.getElementById('date').value,
        contact: document.getElementById('contact').value,
        latitude: document.getElementById('latitude').value,
        longitude: document.getElementById('longitude').value,
        elevation: document.getElementById('elevation').value,
        crop: document.getElementById('crop').value,
        otherCrop: document.getElementById('otherCrop') ? document.getElementById('otherCrop').value : '',
        area: document.getElementById('area').value,
        slopeValue: document.getElementById('slopeValue').value,
        slopeUnit: document.getElementById('slopeUnit').value,
        slopeDirection: document.getElementById('slopeDirection').value,
        landscapePosition: document.getElementById('landscapePosition').value,
        surfaceForm: document.getElementById('surfaceForm').value,
        tillageDepth: document.getElementById('tillageDepth').value,
        strength: document.getElementById('strength').value,
        strengthUnit: document.getElementById('strengthUnit').value,
        vess: document.getElementById('vess').value,
        infiltration: document.getElementById('infiltration').value,
        ph: document.getElementById('ph').value,
        soilColor: document.getElementById('soilColor').value
      };

      const existingData = JSON.parse(localStorage.getItem('soilData')) || [];
      existingData.push(formData);
      localStorage.setItem('soilData', JSON.stringify(existingData));

      alert('Data saved successfully! Your tracking code is: ' + formData.farmId);
      window.location.href = 'database.html'; // ÿ™ÿ∫€å€åÿ± ÿ®Ÿá ÿµŸÅÿ≠Ÿá ÿØ€åÿ™ÿßÿ®€åÿ≥
    }

    document.getElementById('finalSubmitButton').addEventListener('click', () => {
      // Validate all steps before saving
      if (
        validateRequiredFields(['farmerName','date','contact','latitude','longitude']) &&
        validateStep2Fields() &&
        validateStep3Fields() &&
        validateStep4Fields() &&
        validateStep5Fields()
      ) {
        saveFormDataToLocalStorage();
      } else {
        alert('Please fill all required fields in all steps.');
      }
    });

    // Helpers to validate each step (for final check)
    function validateStep2Fields() {
      const crop = document.getElementById('crop').value;
      const otherCrop = document.getElementById('otherCrop').value;
      const area = document.getElementById('area').value;
      if (!crop) return false;
      if (crop === 'Other' && !otherCrop.trim()) return false;
      if (!area) return false;
      return true;
    }
    function validateStep3Fields() {
      const requiredIds = ['slopeValue', 'slopeDirection', 'landscapePosition', 'surfaceForm'];
      for (const id of requiredIds) {
        const el = document.getElementById(id);
        if (!el.value || !el.value.trim()) return false;
      }
      return true;
    }
    function validateStep4Fields() {
      const requiredIds = ['tillageDepth', 'strength', 'vess', 'infiltration'];
      for (const id of requiredIds) {
        const el = document.getElementById(id);
        if (!el.value || !el.value.trim()) return false;
      }
      return true;
    }
    function validateStep5Fields() {
      const requiredIds = ['ph', 'soilColor'];
      for (const id of requiredIds) {
        const el = document.getElementById(id);
        if (!el.value || !el.value.trim()) return false;
      }
      return true;
    }

    // Generate farmId on load
    window.addEventListener('DOMContentLoaded', () => {
      const now = new Date();
      const year = now.getFullYear().toString().slice(-2);
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const rand = String(Math.floor(1 + Math.random() * 9999)).padStart(4, '0');
      document.getElementById('farmId').value = `${year}${month}${day}-${rand}`;

      setActiveStep(1);
    });
  </script>
</body>
</html>
